/*
 * openshift basic identity
 *
 * openshift basic identity provider
 *
 * API version: 1.0.0
 * Contact: zhu.xiaowei@99cloud.net
 * Generated by: Swagger Codegen (https://github.com/swagger-api/swagger-codegen.git)
 */

package swagger

import (
	"encoding/base64"
	"io/ioutil"
	"log"
	"fmt"
	"net/http"
	"openshift-basic-identity-provider/db"
	"openshift-basic-identity-provider/helper"
	"strings"
)

func CreateUser(w http.ResponseWriter, r *http.Request) {
	if r.Header["Isadmin"][0] != "admin" {
		helper.ResponseWithJson(w, http.StatusForbidden,
			helper.Response{Code: http.StatusForbidden, Msg: "permission denied"})
		return
	}

	//w.Header().Set("Content-Type", "application/json; charset=UTF-8")
	bodyBytes, err := ioutil.ReadAll(r.Body)
	if err != nil {
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusBadRequest,
			helper.Response{Code: http.StatusBadRequest, Msg: "bad params"})
		return
	}
	bodyString := string(bodyBytes)
	var userinfo db.User
	helper.UnmarshaUp(bodyString, &userinfo)

	if userinfo.Password == "" {
		helper.ResponseWithJson(w, http.StatusBadRequest,
			helper.Response{Code: http.StatusBadRequest, Msg: "bad params"})
		return
	}

	userinfo.Password=db.AesEncrypt(userinfo.Password, *db.SALT_KEY)
	if err:=db.DB.Save(&userinfo); err != nil{
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusInternalServerError,
			helper.Response{Code: http.StatusInternalServerError, Msg: "internal error"})
		return
	}
	//w.WriteHeader(http.StatusOK)
	userinfo.Password=""
	helper.ResponseWithJson(w, http.StatusOK,
		helper.Response{Code: http.StatusOK, Data: userinfo})
}

func DeleteUser(w http.ResponseWriter, r *http.Request) {
	if r.Header["Isadmin"][0] != "admin" {
		helper.ResponseWithJson(w, http.StatusForbidden,
			helper.Response{Code: http.StatusForbidden, Msg: "permission denied"})
		return
	}
	temp := strings.Split(r.URL.Path, "/")
	username := temp[len(temp)-1]

	if err:= db.DB.Delete(&db.User{}, "username=?", username); err != nil {
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusInternalServerError,
			helper.Response{Code: http.StatusInternalServerError, Msg: "internal error"})
		return
	}
	w.Header().Set("Content-Type", "application/json; charset=UTF-8")
	w.WriteHeader(http.StatusOK)
}


func ListUsers(w http.ResponseWriter, r *http.Request) {
	//w.Header().Set("Content-Type", "application/json; charset=UTF-8")
	fmt.Println(r.Header["Isadmin"][0])

	if r.Header["Isadmin"][0] != "admin" {
		helper.ResponseWithJson(w, http.StatusForbidden,
			helper.Response{Code: http.StatusForbidden, Msg: "permission denied"})
		return
	}

	users := []db.User{}
	//query
	if err:= db.DB.Find(&users); err != nil && err.Error() != "record not found"{
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusInternalServerError,
			helper.Response{Code: http.StatusInternalServerError, Msg: "internal error"})
		return
	}
	for index := range users{
		users[index].Password=""
	}

	helper.ResponseWithJson(w, http.StatusOK,
		helper.Response{Code: http.StatusOK, Data: users})
}

func Login(w http.ResponseWriter, r *http.Request) {
	//w.Header().Set("Content-Type", "application/json; charset=UTF-8")

	var userinfo db.User

	auth := strings.Replace(r.Header["Authorization"][0],"Basic ", "", 1)
	credential, _ := base64.StdEncoding.DecodeString(auth)
	userAndPassword := strings.Split(string(credential), ":")
	userAndPassword[1] = db.AesEncrypt(userAndPassword[1], *db.SALT_KEY)

	if err:= db.DB.Find(&userinfo, "username =? and password=?",userAndPassword[0],userAndPassword[1]); err != nil{
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusNotFound,
			helper.Response{Code: http.StatusNotFound, Msg: "the user not exist"})
		return
	}
	token, _ := GenerateToken(&userinfo)
	helper.ResponseWithJson(w, http.StatusOK,
		helper.Response{Code: http.StatusOK, Data: JwtToken{Token: token}})
}

func LoginForOpenshift(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json; charset=UTF-8")

	var userinfo db.User

	auth := strings.Replace(r.Header["Authorization"][0],"Basic ", "", 1)
	credential, _ := base64.StdEncoding.DecodeString(auth)
	userAndPassword := strings.Split(string(credential), ":")
	userAndPassword[1] = db.AesEncrypt(userAndPassword[1], *db.SALT_KEY)

	if err:= db.DB.Find(&userinfo, "username =? and password=?",userAndPassword[0],userAndPassword[1]); err != nil{
		log.Printf("%s", err)
		w.WriteHeader(http.StatusUnauthorized)
		_, _ = w.Write(helper.MarshaUp(InlineResponse403{Error_: err.Error()}))
		return
	}

	userinfo.Password=""
	userinfo.Sub = string(userinfo.ID)
	userinfo.PreferredUsername = userinfo.Name
	userinfo.Username = ""
	w.WriteHeader(http.StatusOK)
	execStatus, err := w.Write(helper.MarshaUp(userinfo))
	if err != nil {
		w.WriteHeader(execStatus)
		// ignore error
		_, _ = w.Write(helper.MarshaUp(InlineResponse403{Error_: err.Error()}))
		return
	}
}


func UpdateUser(w http.ResponseWriter, r *http.Request) {
	//w.Header().Set("Content-Type", "application/json; charset=UTF-8")
	if r.Header["Isadmin"][0] != "admin" {
		helper.ResponseWithJson(w, http.StatusForbidden,
			helper.Response{Code: http.StatusForbidden, Msg: "permission denied"})
		return
	}
	temp := strings.Split(r.URL.Path, "/")
	username := temp[len(temp)-1]
	bodyBytes, err := ioutil.ReadAll(r.Body)
	if err != nil {
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusBadRequest,
			helper.Response{Code: http.StatusBadRequest, Msg: "bad params"})
		return
	}
	bodyString := string(bodyBytes)
	var userinfo db.User
	helper.UnmarshaUp(bodyString, &userinfo)

	userinfo.Password=db.AesEncrypt(userinfo.Password, *db.SALT_KEY)
	if err := db.DB.Update(&userinfo, "username=?", username); err != nil {
		log.Printf("%s", err)
		helper.ResponseWithJson(w, http.StatusInternalServerError,
			helper.Response{Code: http.StatusInternalServerError, Msg: "internal error"})
		return
  }
	w.WriteHeader(http.StatusOK)
}
